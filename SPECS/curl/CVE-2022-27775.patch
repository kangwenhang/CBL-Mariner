From 46091487fbdb37ffbe9c495de86c62d14634b71a Mon Sep 17 00:00:00 2001
From: Daniel Stenberg <daniel@haxx.se>
Date: Thu, 21 Apr 2022 12:30:34 +0200
Subject: [PATCH] conncache: include the zone id in the "bundle" hashkey

Make connections to two separate IPv6 zone ids create separate
connections.

Backported to curl version 7.76.0

Reported-by: Harry Sintonen
Bug: https://curl.se/docs/CVE-2022-27775.html
Signed-off-by: Henry Beberman <henry.beberman@microsoft.com>

diff -Nar -U 5 a/lib/conncache.c b/lib/conncache.c
--- a/lib/conncache.c	2022-04-22 18:17:24.673469012 -0700
+++ b/lib/conncache.c	2022-04-22 18:17:01.429473700 -0700
@@ -157,12 +157,16 @@
 
   if(hostp)
     /* report back which name we used */
     *hostp = hostname;
 
-  /* put the number first so that the hostname gets cut off if too long */
-  msnprintf(buf, len, "%ld%s", port, hostname);
+  /* put the numbers first so that the hostname gets cut off if too long */
+#ifdef ENABLE_IPV6
+  msnprintf(buf, len, "%u/%ld/%s", conn->scope_id, port, hostname);
+#else
+  msnprintf(buf, len, "%ld/%s", port, hostname);
+#endif
 }
 
 /* Returns number of connections currently held in the connection cache.
    Locks/unlocks the cache itself!
 */
